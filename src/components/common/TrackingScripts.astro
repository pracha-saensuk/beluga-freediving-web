<script>
import { nanoid } from 'nanoid';
import { getFromStore, getQueryParamsWithLastValue, storeIfExists } from '~/utils/webUtils';

let query = getQueryParamsWithLastValue();
	const trafficSource = query.utm_source || query.ts || query.network;
	const medium = query.utm_medium;
	const campaign = query.utm_campaign;
	const content = query.utm_content;
	const term = query.utm_term;
	const gclid = query.gclid;
	const ttclid = query.ttclid;
	const fbclid = query.fbclid;
	const clickId = query.clid || gclid || ttclid || query.clickid || query.cid || query.adclid;
	const lineUid = query.lineuid || query.lineid || query.lineUid;
	const fbBusinessId = query.business_id;
	const fbAssetId = query.asset_id;
	const fbSelectedId = query.selected_item_id;
	const fbMailBoxId = query.mailbox_id;

	let userId = getFromStore('userId');
	console.log('u1:',userId);
	if(!userId){
		console.log('not exists');
		userId = nanoid();
		storeIfExists('userId',userId);
	}else{
		console.log('exists');
	}
	console.log('u2:',userId);
	storeIfExists('fbBusinessId',fbBusinessId);
	storeIfExists('fbAssetId',fbAssetId);
	storeIfExists('fbSelectedId',fbSelectedId);
	storeIfExists('fbMailBoxId',fbMailBoxId);
	storeIfExists('lineUid',lineUid);
	storeIfExists('clickId',clickId);
	storeIfExists('ttclid',ttclid);
	storeIfExists('gclid',gclid);
	storeIfExists('fbclid',fbclid);
	storeIfExists('trafficSource', trafficSource);
	storeIfExists('medium', medium);
	storeIfExists('campaign', campaign);
	storeIfExists('content', content); // teaser
	storeIfExists('term',term); // widget
	// Click "Preview" to run your code
	const userAgent = navigator.userAgent;
	const payload = {
		url: window.location.href,
		userAgent,
		referrer: document.referrer,
		userId,
		trafficSource,
		medium,
		content,
		campaign,
		term,
		lineUid,
		clickId,
		ttclid,
		gclid,
		fbclid,
		fbAssetId,
		fbBusinessId,
		fbSelectedId,
		fbMailBoxId,
	}
	const fetchOptions = {
    method: 'post',
    // headers: 'application/json',
    body: JSON.stringify(payload)
  };
  console.log('payload',payload);
  console.log(fetchOptions);
  const response = await fetch('https://asia-southeast1-beluga-freediving-school.cloudfunctions.net/api', fetchOptions).catch(console.log);
  console.log('response',response);

</script>
